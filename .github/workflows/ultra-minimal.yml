name: OpenWrt Minimal AP (WR1043ND v1, ath79 ultra-minimal)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Clone OpenWrt source
      run: |
        git clone --branch v19.07.10 https://github.com/openwrt/openwrt.git openwrt

    - name: Install build dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential clang flex bison gawk gettext \
          libncurses-dev libssl-dev python2 python2-minimal \
          rsync unzip file wget
        sudo update-alternatives --install /usr/bin/python python /usr/bin/python2 1
        sudo update-alternatives --set python /usr/bin/python2

    - name: Configure OpenWrt (ultra-minimal ath79)
      run: |
        cat << 'EOF' > openwrt/.config
        # Target
        CONFIG_TARGET_ath79=y
        CONFIG_TARGET_ath79_generic=y
        CONFIG_TARGET_ath79_generic_DEVICE_tplink_tl-wr1043nd-v1=y

        # Essential system
        CONFIG_BUSYBOX=y
        CONFIG_DROPBEAR=y
        CONFIG_UBUS=y
        CONFIG_UBUSD=y
        CONFIG_UCI=y
        CONFIG_LOGD=y
        CONFIG_PROCD=y

        # Wireless stack (modular)
        CONFIG_PACKAGE_kmod-ath9k=y
        CONFIG_PACKAGE_kmod-mac80211=y
        CONFIG_PACKAGE_kmod-cfg80211=y
        CONFIG_PACKAGE_wpad-basic-wolfssl=y
        CONFIG_PACKAGE_iw=y

        # Networking
        CONFIG_PACKAGE_bridge-utils=y

        # Disable firewall & netfilter completely
        CONFIG_PACKAGE_firewall=n
        CONFIG_PACKAGE_iptables=n
        CONFIG_PACKAGE_ip6tables=n
        CONFIG_PACKAGE_kmod-ipt-core=n
        CONFIG_PACKAGE_kmod-ipt-nat=n
        CONFIG_PACKAGE_kmod-nf-conntrack=n
        CONFIG_PACKAGE_kmod-nf-nat=n
        CONFIG_PACKAGE_kmod-br-netfilter=n

        # Disable VLAN / swconfig
        CONFIG_PACKAGE_swconfig=n

        # Disable DHCP/DNS
        CONFIG_PACKAGE_dnsmasq=n
        CONFIG_PACKAGE_odhcpd=n

        # Disable IPv6
        CONFIG_IPV6=n

        # Kernel size reduction
        CONFIG_VMLINUX_STRIP=y
        CONFIG_KERNEL_PRINTK=n
        CONFIG_KERNEL_DEBUG_FS=n
        EOF

    - name: Embed system configuration
      run: |
        mkdir -p openwrt/files/etc/config

        cat << 'EOF' > openwrt/files/etc/config/network
        config interface 'lan'
            option type 'bridge'
            option ifname 'eth0'
            option proto 'static'
            option ipaddr '192.168.10.1'
            option netmask '255.255.255.0'
        EOF

        cat << 'EOF' > openwrt/files/etc/config/wireless
        config wifi-device 'radio0'
            option type 'mac80211'
            option channel '6'
            option hwmode '11ng'
            option htmode 'HT20'

        config wifi-iface
            option device 'radio0'
            option mode 'ap'
            option network 'lan'
            option ssid 'AP_ONLY'
            option encryption 'psk2'
            option key 'strongpassword'
        EOF

    - name: Update and install feeds
      working-directory: openwrt
      run: |
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Build OpenWrt firmware (single-thread, verbose)
      working-directory: openwrt
      run: |
        make defconfig
        make -j1 V=s

    - name: Upload firmware
      uses: actions/upload-artifact@v4
      with:
        name: wr1043nd-v1-ath79-ultra-minimal
        path: openwrt/bin/targets/ath79/generic/*.bin
