name: OpenWrt Minimal AP (WR1043ND v1)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Checkout OpenWrt source
      run: |
        git clone --branch v19.07.10 https://github.com/openwrt/openwrt.git openwrt
        
    - name: Install build dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential flex bison gawk gettext \
          libncurses-dev libssl-dev python2 python2-minimal \
          rsync unzip file wget
        # Make python command point to python2
        sudo update-alternatives --install /usr/bin/python python /usr/bin/python2 1
        sudo update-alternatives --set python /usr/bin/python2

    - name: Apply OpenWrt config
      run: |
        cat << 'EOF' > openwrt/.config
        CONFIG_TARGET_ar71xx=y
        CONFIG_TARGET_ar71xx_generic=y
        CONFIG_TARGET_ar71xx_generic_DEVICE_tl-wr1043nd-v1=y
        
        CONFIG_BUSYBOX=y
        CONFIG_DROPBEAR=y
        CONFIG_UBUS=y
        CONFIG_UBUSD=y
        CONFIG_UCI=y
        
        CONFIG_PACKAGE_kmod-ath9k=y
        CONFIG_PACKAGE_wpad-basic-wolfssl=y
        CONFIG_PACKAGE_iw=y
        CONFIG_PACKAGE_swconfig=y
        
        # Explicit removals
        # CONFIG_PACKAGE_luci is not set
        # CONFIG_PACKAGE_uhttpd is not set
        # CONFIG_PACKAGE_firewall is not set
        # CONFIG_PACKAGE_dnsmasq is not set
        # CONFIG_PACKAGE_odhcpd is not set
        # CONFIG_PACKAGE_ppp is not set
        # CONFIG_PACKAGE_ip6tables is not set
        # CONFIG_PACKAGE_iptables is not set
        EOF
    
    - name: Apply kernel config overrides
      run: |
        mkdir -p openwrt/target/linux/ar71xx/config-4.14
        cat << 'EOF' > openwrt/target/linux/ar71xx/config-4.14/99-minimal-ap
        CONFIG_MODULES=y
    
        # Disable firewall / netfilter
        CONFIG_NETFILTER=n
        CONFIG_NETFILTER_ADVANCED=n
        CONFIG_NF_CONNTRACK=n
        CONFIG_NF_NAT=n
        CONFIG_IP_NF_IPTABLES=n
        CONFIG_BRIDGE_NETFILTER=n
    
        # Disable IPv6
        CONFIG_IPV6=n
    
        # Required networking
        CONFIG_INET=y
        CONFIG_BRIDGE=y
    
        # Wireless stack
        CONFIG_MAC80211=m
        CONFIG_CFG80211=m
    
        # Silence ALL cfg80211 interactive options
        CONFIG_NL80211_TESTMODE=n
        CONFIG_CFG80211_DEVELOPER_WARNINGS=n
        CONFIG_CFG80211_CERTIFICATION_ONUS=n
    
        # Kernel trimming
        CONFIG_DEBUG_KERNEL=n
        CONFIG_CGROUPS=n
        EOF

    - name: Embed system configs
      run: |
        mkdir -p openwrt/files/etc/config
        cat << 'EOF' > openwrt/files/etc/config/network
        config switch
            option name 'switch0'
            option reset '1'
            option enable_vlan '1'
        
        config switch_vlan
            option device 'switch0'
            option vlan '1'
            option ports '0 1 2 3 4'
        
        config interface 'lan'
            option type 'bridge'
            option ifname 'eth0.1'
            option proto 'static'
            option ipaddr '192.168.10.1'
            option netmask '255.255.255.0'
        EOF

        cat << 'EOF' > openwrt/files/etc/config/wireless
        config wifi-device 'radio0'
            option type 'mac80211'
            option channel '6'
            option hwmode '11ng'
            option htmode 'HT20'
            option path 'platform/ar934x_wmac'
        
        config wifi-iface
            option device 'radio0'
            option mode 'ap'
            option network 'lan'
            option ssid 'AP_ONLY'
            option encryption 'psk2'
            option key 'strongpassword'
        EOF
        
    - name: Update feeds
      working-directory: openwrt
      run: |
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Build OpenWrt firmware (debug)
      working-directory: openwrt
      run: |
        make defconfig
        make -j1 V=s 2>&1 | tee build.log
        
    - name: Upload build log
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-build-log
        path: openwrt/build.log

    - name: Upload firmware
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-wr1043nd-v1-minimal
        path: openwrt/bin/targets/ar71xx/generic/*.bin
